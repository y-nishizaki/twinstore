# 類似店舗マッチング機能 要件仕様書

**作成日**: 2025-07-23  
**最終更新**: 2025-07-23  
**ステータス**: Draft  

## 機能概要

類似店舗マッチング機能は、新規店舗の売上パターンと過去の店舗データを比較し、最も類似した成長パターンを持つ店舗を特定する機能です。DTW（動的時間伸縮法）を中心とした複数のアルゴリズムにより、時間軸の違いを吸収した高精度な類似性判定を実現します。

## ユーザーストーリー

### US-SM-001: 基本的な類似店舗検索
**As a** データアナリスト  
**I want** 新規店舗に類似した過去店舗を検索したい  
**So that** 予測精度を向上させられる  

**受け入れ基準:**
- GIVEN 新規店舗データと過去店舗データベースがある
- WHEN find_similar()メソッドを実行する
- THEN 類似度順にランキングされた店舗リストが返される

### US-SM-002: 複数アルゴリズムの選択
**As a** システム管理者  
**I want** 業態に応じて類似性計算手法を選択したい  
**So that** 最適な類似店舗検索が可能になる  

**受け入れ基準:**
- GIVEN 類似性計算の設定がある
- WHEN アルゴリズムを指定する
- THEN 指定したアルゴリズムで類似性が計算される

### US-SM-003: 時間軸調整機能
**As a** 予測エンジン  
**I want** 異なる期間のデータ間で類似性を計算したい  
**So that** 多様な店舗データを活用できる  

**受け入れ基準:**
- GIVEN 異なる期間の売上データがある
- WHEN 期間調整機能を使用する
- THEN 統一された期間で類似性が計算される

### US-SM-004: 類似度閾値フィルタリング
**As a** 予測システム  
**I want** 一定以上の類似度を持つ店舗のみを抽出したい  
**So that** 予測品質を保証できる  

**受け入れ基準:**
- GIVEN 類似度閾値設定がある
- WHEN 類似店舗検索を実行する
- THEN 閾値以上の類似度を持つ店舗のみが返される

## 機能仕様

### 基本機能

1. **類似性計算アルゴリズム**
   - DTW（動的時間伸縮法）: デフォルト手法
   - コサイン類似度: ベクトル角度による類似性
   - 相関係数: 線形関係の強さ
   - ユークリッド距離: 多次元空間での直線距離

2. **時間軸調整**
   - 期間アライメント: 異なる期間データの統一
   - ウィンドウ制約: DTW計算の効率化
   - 季節性考慮: 周期的パターンの調整

3. **結果フィルタリング**
   - 類似度閾値フィルタ
   - 最大結果数制限
   - 品質スコアによる除外

4. **類似店舗情報**
   - 店舗識別情報
   - 類似度スコア
   - DTW距離値
   - アライメント期間
   - 売上パターンデータ

### 高度な機能

1. **適応的パラメータ調整**
   - データ特性に応じたウィンドウサイズ自動調整
   - 異常値検出による前処理
   - 正規化手法の自動選択

2. **マルチスケール分析**
   - 日次・週次・月次レベルでの類似性計算
   - 複数期間での一致度評価
   - 成長ステージ別マッチング

3. **クラスタリング統合**
   - 類似店舗群の自動グルーピング
   - 代表店舗の選定
   - グループ内多様性の確保

## 非機能要件

### パフォーマンス
- **計算時間**: 1000店舗データベースに対して10秒以内
- **メモリ使用量**: DTW計算1件あたり50MB以内
- **並列処理**: マルチスレッド対応

### 精度
- **類似度精度**: 人間の判定と80%以上の一致
- **ランキング精度**: 上位5位内での90%一致率
- **安定性**: 同一データでの再現性100%

### スケーラビリティ
- **データベースサイズ**: 10,000店舗まで対応
- **同時処理**: 複数リクエストの並列実行
- **メモリ効率**: 大容量データの段階的処理

## 入力仕様

### データ形式
```python
# 新規店舗データ
target_data = np.array([100, 120, 130, ...])  # 売上時系列

# 過去店舗データベース
historical_data = {
    'store_001': np.array([95, 115, 125, ...]),
    'store_002': np.array([105, 125, 135, ...]),
    # ...
}
```

### パラメータ設定
```python
find_similar(
    target_data,                    # 必須: 検索対象データ
    historical_data,                # 必須: 過去データベース
    method='dtw',                   # 類似性計算手法
    max_results=10,                 # 最大結果数
    similarity_threshold=0.1,       # 類似度閾値
    dtw_window=0.1,                # DTWウィンドウ制約
    normalize=True,                 # データ正規化
    alignment_period=None           # アライメント期間
)
```

## 出力仕様

### 基本出力
```python
@dataclass
class SimilarStore:
    store_name: str                 # 店舗識別名
    distance: float                 # DTW距離（小さいほど類似）
    similarity_score: float         # 類似度スコア（0-1、大きいほど類似）
    sales_pattern: np.ndarray       # 売上パターンデータ
    alignment_period: int           # アライメント期間
    metadata: Dict                  # 追加メタデータ

# 戻り値
List[SimilarStore]  # 類似度順にソートされたリスト
```

### 詳細出力（verbose=True）
```python
@dataclass
class DetailedSimilarStore(SimilarStore):
    dtw_path: List[Tuple[int, int]]     # DTWパス情報
    alignment_cost: float               # アライメントコスト
    local_distances: np.ndarray         # 局所距離行列
    quality_metrics: Dict               # 品質指標
    computation_time: float             # 計算時間
```

## アルゴリズム仕様

### DTWアルゴリズム
```python
def dtw_distance(x, y, window_constraint=0.1):
    """
    動的時間伸縮法による距離計算
    
    Parameters:
    - x, y: 比較する時系列データ
    - window_constraint: ウィンドウ制約（0-1）
    
    Returns:
    - distance: DTW距離
    - path: 最適パス
    """
```

### コサイン類似度
```python
def cosine_similarity(x, y):
    """
    コサイン類似度計算
    
    Returns:
    - similarity: コサイン類似度（-1から1）
    """
```

### 相関係数
```python
def correlation_coefficient(x, y):
    """
    ピアソン相関係数計算
    
    Returns:
    - correlation: 相関係数（-1から1）
    """
```

## エラーハンドリング

### 例外タイプ
```python
class SimilarityError(TwinStoreError):
    """類似性計算エラー"""
    pass

class InsufficientHistoricalDataError(SimilarityError):
    """過去データ不足エラー"""
    pass

class DTWComputationError(SimilarityError):
    """DTW計算エラー"""
    pass

class DataAlignmentError(SimilarityError):
    """データアライメントエラー"""
    pass
```

### エラー対応
- **データ不足**: 最小データ要件未満の場合
- **計算エラー**: DTW計算過程での数値エラー
- **メモリ不足**: 大容量データ処理時
- **形状不一致**: データ次元の不整合

## 品質保証

### テストケース
1. **正常系テスト**
   - 標準的なデータでの類似性計算
   - 各アルゴリズムの動作確認
   - 期間調整機能のテスト

2. **異常系テスト**
   - 空データでの例外処理
   - 異常値データでの動作
   - メモリ制限での処理

3. **性能テスト**
   - 大容量データでの処理時間
   - メモリ使用量の測定
   - 並列処理の効果確認

### 精度検証
- **合成データテスト**: 既知パターンでの精度確認
- **実データ検証**: 実際の店舗データでの妥当性確認
- **専門家評価**: ドメインエキスパートによる結果評価

## 依存関係

### 前提機能
- データ正規化機能（Normalizer）
- データバリデーション（DataValidator）
- 基本統計関数（utils.statistics）

### 影響範囲
- 売上予測機能（予測精度に直接影響）
- 可視化機能（類似店舗比較グラフ）
- レポート生成（類似性分析レポート）

## 実装優先度

### 高優先度（Phase 1）
1. DTWアルゴリズム実装
2. 基本的な類似店舗検索
3. 結果フィルタリング機能

### 中優先度（Phase 2）
1. 複数アルゴリズムサポート
2. 時間軸調整機能
3. 性能最適化

### 低優先度（Phase 3）
1. 高度な分析機能
2. クラスタリング統合
3. 詳細診断機能